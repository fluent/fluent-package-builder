<?xml version='1.0'?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <Product Id="*" Name="!(loc.ProductName) v$(var.DisplayVersionNumber)" Language="!(loc.LANG)"
          Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">

    <!--
      Minimum installer version (2.0) - Window XP and above.
      The install scope is per machine, not the current user
    -->
    <Package InstallerVersion="200" InstallPrivileges="elevated"
             Compressed="yes" InstallScope="perMachine" />

    <Media Id="1" Cabinet="Project.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- We always do Major upgrades -->
    <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeErrorMessage)" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WINDOWSVOLUME">
        <Directory Id="OPTLOCATION" Name="opt">
          <Directory Id="FLUENTPROJECTLOCATION" Name="fluent">
            <Component Id="FluentAcl" Guid="c2bba014-c3c1-4817-a0c6-096dbd95991d">
              <CreateFolder>
                <!--
                  The following ACL will be set by Sddl=

                    BUILTIN\Users:(OI)(CI)R
                    BUILTIN\Administrators:(OI)(CI)F
                    NT SERVICE\TrustedInstaller:(OI)(CI)F
                    CREATOR OWNER:(OI)(CI)F
                    NT AUTHORITY\SYSTEM:(OI)(CI)F

                  ref. https://wixtoolset.org/documentation/manual/v3/xsd/wix/permissionex.html
                       https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists
                       https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-string-format
                       https://docs.microsoft.com/en-us/windows/win32/secauthz/ace-strings
                       https://docs.microsoft.com/en-us/windows/win32/secauthz/sid-strings
                       https://docs.microsoft.com/en-us/windows/win32/fileio/file-access-rights-constants

                  NOTE:
                  * Security Descriptor String Format
                    O:owner_sid
                    G:group_sid
                    D:dacl_flags(string_ace1)(string_ace2)... (string_acen)
                    S:sacl_flags(string_ace1)(string_ace2)... (string_acen)
                  * ACE (Access Control Entry) String format:
                    ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid
                    * (A;OICI;0x1200a9;;;BU) => Builtin Users is allowed to read/exec
                  * ace_type:
                    * A: SDDL_ACCESS_ALLOWED
                  * ace_flags:
                    * OI: SDDL_CONTAINER_INHERIT
                    * CI: SDDL_OBJECT_INHERIT
                  * rights:
                    * FA: SDDL_FILE_ALL
                    * 0x1200a9: SYNCHRONIZE(0x100000) | READ_CONTROL(0x2000) | FILE_READ_ATTRIBUTES(0x80) | FILE_EXECUTE(0x20) | FILE_READ_EA(0x8) | FILE_READ_DATA(0x1)
                  * account_sid:
                    * BU: SDDL_BUILTIN_USERS
                    * BA: SDDL_BUILTIN_ADMINISTRATORS
                    * CO: SDDL_CREATOR_OWNER
                    * SY: SDDL_LOCAL_SYSTEM
                    * S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464: NT SERVICE\TrustedInstaller
                -->
                <PermissionEx Sddl="D:(A;OICI;0x1200a9;;;BU)(A;OICI;FA;;;BA)(A;OICI;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;OICI;FA;;;CO)(A;OICI;FA;;;SY)"/>
              </CreateFolder>
            </Component>
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramFolder" Name="!(loc.ProductName)" />
      </Directory>
    </Directory>

    <DirectoryRef Id="FLUENTPROJECTLOCATION">
      <Directory Id="FluentEtcDir" Name="etc">
        <Directory Id="FluentConfDir" Name="fluent">
          <Component Id="FluentConf"
                     Guid="340cc0a1-83cc-42df-bb66-290264c6c37b"
                     Permanent="yes"
                     NeverOverwrite="yes">
            <File Id="FluentConf"
                  Name="fluentd.conf"
                  Source="$(var.ProjectSourceDir)\etc\fluent\fluentd.conf" />
          </Component>
        </Directory>
      </Directory>
      <Component Id="FluentdBat" Guid="261158e8-7b22-48ff-b7eb-9f8296f30236">
        <File Name="fluentd.bat"
              KeyPath="yes"
              Source="$(var.ProjectSourceDir)\fluentd.bat" />
        <ServiceControl Id="ServiceControlFluentdWinSvc"
                        Name="fluentdwinsvc"
                        Stop="uninstall"
                        Remove="uninstall" />
      </Component>
    </DirectoryRef>

    <SetDirectory Id="WINDOWSVOLUME" Value="[WindowsVolume]" />

    <!-- Shortcut on Start Menu -->
    <DirectoryRef Id="ApplicationProgramFolder">
      <Component Id="ApplicationShortcut" Guid="*">
        <Shortcut Id="ApplicationShortcut" Name="!(loc.ProductName) Command Prompt" Description="Open !(loc.ProductName) Command Prompt" Target="[SystemFolder]cmd.exe" Arguments='/k "[FLUENTPROJECTLOCATION]fluent-package-prompt.bat"' WorkingDirectory="FLUENTPROJECTLOCATION" />
        <RemoveFolder Id="ApplicationProgramFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Name="installed" Type="integer" Value="1" KeyPath="yes" />
        <Environment Id="ProjectLocationDirForConf"
                     Action="set"
                     Permanent="no"
                     Part="all"
                     System="yes"
                     Name="FLUENT_PACKAGE_TOPDIR"
                     Value="[FLUENTPROJECTLOCATION]"/>
        <Environment Id="CompatProjectLocationDirForConf"
                     Action="set"
                     Permanent="no"
                     Part="all"
                     System="yes"
                     Name="TD_AGENT_TOPDIR"
                     Value="[OPTLOCATION]td-agent\"/>
      </Component>
    </DirectoryRef>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="ProjectFeature" Title="!(loc.FeatureMainName)" Absent="disallow" AllowAdvertise="no" Level="1" ConfigurableDirectory="OPTLOCATION">
      <ComponentGroupRef Id="ProjectDir" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="FluentConf" />
      <ComponentRef Id="FluentAcl" />
      <ComponentRef Id="FluentdBat" />
      <ComponentGroupRef Id="KeepUserRegistryConfiguration" />
    </Feature>

    <!-- UI Stuff -->
    <Icon Id="project.ico" SourceFile="assets\icon.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="http://www.fluentd.org/" />
    <Property Id="WIXUI_INSTALLDIR" Value="OPTLOCATION" />

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_FeatureTree"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="assets\banner_background.bmp" />

    <WixVariable Id="WixUIExclamationIco" Value="assets\icon.ico" />
    <WixVariable Id="WixUIInfoIco" Value="assets\icon.ico" />

    <!-- Save old some registry values -->
    <Property Id="REGISTRY_START_OLD">
      <RegistrySearch Id="RegistrySearchStart" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="Start" Type="raw" />
    </Property>
    <Property Id="REGISTRY_DELAYEDAUTOSTART_OLD">
      <RegistrySearch Id="RegistrySearchDelayedAutostart" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="DelayedAutostart" Type="raw" />
    </Property>
    <Property Id="REGISTRY_FLUENTDOPT_OLD">
      <RegistrySearch Id="RegistrySearchFluentdopt" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="fluentdopt" Type="raw" />
    </Property>

    <!-- Restore some registry values -->
    <ComponentGroup Id="KeepUserRegistryConfiguration" Directory="FLUENTPROJECTLOCATION">
      <!--
        CAUTION: We cannot use `integer` type for values being read by RegistrySearch. Use `string` instead.
        DETAIL: RegistrySearch reads a raw value and the value could have a prefix according to the data type.
        For example, integer (DWORD) value has a `#` prefix.
        If writing such a value (e.g., `#2`) by `RegistryValue` with `integer` type, it is forced to be recognized as `REG_SZ` type after all, and it breaks the service.
        We want to remove the prefix before `RegistryValue`, but it is hard to do with WiX.
        However, using `string` type can handle such raw values.
        For example, if writing `#2` by `RegistryValue` with `string` type, it is written as `2` with `REG_DWORD` type.
        (Though this is undocumented... https://wixtoolset.org/docs/v3/xsd/wix/registryvalue/)
        Thus, it is better to use `string` type to handle such raw values in this context because of no need to care about '#' prefix.
       -->

      <!-- Start -->
      <Component Id="SetRegistryStart" Guid="5759ebf0-a248-4e78-82be-9334421100b2">
        <Condition><![CDATA[REGISTRY_START_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueStart" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="Start" Value="[REGISTRY_START_OLD]" Type="string" KeyPath="yes" />
      </Component>

      <!-- DelayedAutostart -->
      <Component Id="SetRegistryDelayedAutostart" Guid="8cb98306-8219-400f-b8b3-e5ffca828cd4">
        <Condition><![CDATA[REGISTRY_DELAYEDAUTOSTART_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueDelayedAutostart" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="DelayedAutostart" Value="[REGISTRY_DELAYEDAUTOSTART_OLD]" Type="string" KeyPath="yes" />
      </Component>

      <!-- fluentdopt -->
      <Component Id="SetRegistryFleuntdopt" Guid="c94bc7e4-9cf2-4b8c-925f-e015958a94e9">
        <Condition><![CDATA[REGISTRY_FLUENTDOPT_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueFleuntdopt" Root="HKLM" Key="System\CurrentControlSet\Services\fluentdwinsvc" Name="fluentdopt" Value="[REGISTRY_FLUENTDOPT_OLD]" Type="string" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Settle paths in executables generated by RubyGems -->
    <Property Id="PostInstall" Value=" "/>
    <CustomAction Id="SetPostInstallCommand"
                  Property="PostInstall"
                  Value="&quot;[FLUENTPROJECTLOCATION]bin\fluent-package-post-install.bat&quot;"/>
    <CustomAction Id="PostInstall"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <Property Id="PostMigration" Value=" "/>
    <CustomAction Id="SetPostMigrationCommand"
                  Property="PostMigration"
                  Value="&quot;[FLUENTPROJECTLOCATION]bin\fluent-package-post-migration.bat&quot;"/>
    <CustomAction Id="PostMigration"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <Property Id="InstallFluentdWinSvc" Value=" "/>
    <CustomAction Id="SetInstallFluentdWinSvcCommand"
                  Property="InstallFluentdWinSvc"
                  Value="&quot;[FLUENTPROJECTLOCATION]fluentd.bat&quot; --reg-winsvc i --reg-winsvc-delay-start --reg-winsvc-fluentdopt &quot;-c '[FLUENTPROJECTLOCATION]etc\fluent\fluentd.conf' -o '[FLUENTPROJECTLOCATION]fluentd.log'&quot;"/>
    <CustomAction Id="InstallFluentdWinSvc"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <Property Id="CreateCompatTdAgentBat" Value=" "/>
    <CustomAction Id="SetCreateCompatTdAgentBat"
                  Property="CreateCompatTdAgentBat"
                  Value="&quot;cmd&quot; /c &quot;fsutil hardlink create ^&quot;[FLUENTPROJECTLOCATION]bin\td-agent.bat^&quot; ^&quot;[FLUENTPROJECTLOCATION]fluentd.bat^&quot;&quot;"/>
    <CustomAction Id="CreateCompatTdAgentBat"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />
    <Property Id="CreateCompatTdAgentGemBat" Value=" "/>
    <CustomAction Id="SetCreateCompatTdAgentGemBat"
                  Property="CreateCompatTdAgentGemBat"
                  Value="&quot;cmd&quot; /c &quot;fsutil hardlink create ^&quot;[FLUENTPROJECTLOCATION]bin\td-agent-gem.bat^&quot; ^&quot;[FLUENTPROJECTLOCATION]fluent-gem.bat^&quot;&quot;"/>
    <CustomAction Id="CreateCompatTdAgentGemBat"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <Property Id="DeleteCompatTdAgentBat" Value=" "/>
    <CustomAction Id="SetDeleteCompatTdAgentBat"
                  Property="DeleteCompatTdAgentBat"
                  Value="&quot;cmd&quot; /c &quot;del ^&quot;[FLUENTPROJECTLOCATION]bin\td-agent.bat^&quot;&quot;"/>
    <CustomAction Id="DeleteCompatTdAgentBat"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />
    <Property Id="DeleteCompatTdAgentGemBat" Value=" "/>
    <CustomAction Id="SetDeleteCompatTdAgentGemBat"
                  Property="DeleteCompatTdAgentGemBat"
                  Value="&quot;cmd&quot; /c &quot;del ^&quot;[FLUENTPROJECTLOCATION]bin\td-agent-gem.bat^&quot;&quot;"/>
    <CustomAction Id="DeleteCompatTdAgentGemBat"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <Property Id="PostNotifyWithToastBat" Value=" "/>
    <CustomAction Id="SetPostNotifyWithToastBat"
                  Property="PostNotifyWithToastBat"
                  Value="&quot;[FLUENTPROJECTLOCATION]bin\fluent-package-post-toast.bat&quot;"/>
    <CustomAction Id="PostNotifyWithToastBat"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="yes" />

    <InstallExecuteSequence>
      <Custom Action="SetPostInstallCommand" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="PostInstall" After="SetPostInstallCommand">NOT Installed</Custom>

      <Custom Action="SetPostMigrationCommand" Before="PostMigration">WIX_UPGRADE_DETECTED</Custom>
      <Custom Action="PostMigration" Before="StartServices">WIX_UPGRADE_DETECTED</Custom>

      <Custom Action="SetInstallFluentdWinSvcCommand" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="InstallFluentdWinSvc" After="SetInstallFluentdWinSvcCommand">NOT Installed</Custom>

      <Custom Action="SetCreateCompatTdAgentBat" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="CreateCompatTdAgentBat" After="SetCreateCompatTdAgentBat">NOT Installed</Custom>
      <Custom Action="SetCreateCompatTdAgentGemBat" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="CreateCompatTdAgentGemBat" After="SetCreateCompatTdAgentGemBat">NOT Installed</Custom>

      <!-- Notify enterprise services for Fluentd users -->
      <Custom Action="SetPostNotifyWithToastBat" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="PostNotifyWithToastBat" After="SetPostNotifyWithToastBat">NOT Installed</Custom>

      <!-- Delete hardlink before removing installed files -->
      <Custom Action="SetDeleteCompatTdAgentBat" After="InstallInitialize">Installed AND NOT REINSTALL</Custom>
      <Custom Action="DeleteCompatTdAgentBat" After="SetDeleteCompatTdAgentBat">Installed AND NOT REINSTALL</Custom>
      <Custom Action="SetDeleteCompatTdAgentGemBat" After="InstallInitialize">Installed AND NOT REINSTALL</Custom>
      <Custom Action="DeleteCompatTdAgentGemBat" After="SetDeleteCompatTdAgentGemBat">Installed AND NOT REINSTALL</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
